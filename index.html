<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù†Ø¸Ø§Ù… Ø¥Ù†Ø°Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ â€” Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</title>
  <style>
    body {
      font-family: "Tajawal", sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #fff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 20px;
    }
    .card {
      background: #111;
      padding: 24px;
      border-radius: 12px;
      max-width: 820px;
      width: 95%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    }
    h1 { color: #00e1ff; font-size: 24px; margin-bottom: 10px; }
    .small { font-size: 15px; line-height: 1.6; color: #ccc; }
    .row { display: flex; gap: 10px; margin: 15px 0; }
    input {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: 0;
      font-size: 17px;
      outline: none;
    }
    .badge {
      background: #00e1ff;
      padding: 10px 14px;
      border-radius: 8px;
      color: #111;
      font-weight: 700;
      display: flex;
      align-items: center;
    }
    .info { margin-top: 15px; }
    .small-muted { font-size: 14px; color: #bbb; }
    .log {
      background: #222;
      border-radius: 8px;
      margin-top: 20px;
      padding: 12px;
      font-size: 14px;
      height: 180px;
      overflow-y: auto;
      color: #0ff;
    }

    /* Overlay Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .alert-box {
      background: #111;
      padding: 24px;
      border-radius: 12px;
      max-width: 820px;
      width: 95%;
      display: flex;
      gap: 18px;
      align-items: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    }
    .alert-box img {
      width: 96px;
      height: 96px;
      border-radius: 12px;
      object-fit: cover;
    }
    .alert-content { flex: 1; }
    .alert-title { font-size: 20px; margin: 0 0 6px 0; color: #00e1ff; }
    .alert-text { font-size: 18px; margin: 0 0 12px 0; }
    .alert-actions { display: flex; gap: 10px; }
    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 0;
      cursor: pointer;
      font-weight: 700;
    }
    .btn-stop { background: #444; color: #fff; }
    .btn-dismiss { background: #eee; color: #111; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Ù†Ø¸Ø§Ù… Ø¥Ù†Ø°Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ â€” Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</h1>
    <p class="small">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ (Ù…Ø«Ø§Ù„: 0551234567 Ø£Ùˆ +966551234567). Ø¹Ù†Ø¯ ÙƒØªØ§Ø¨Ø© Ø£ÙŠ Ù…Ù† Ø£Ø±Ù‚Ø§Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø³ÙŠØ´ØºÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ØªÙ†Ø¨ÙŠÙ‡Ù‹Ø§ ØªØ¬Ø±ÙŠØ¨ÙŠÙ‹Ø§ ÙˆÙŠØ³Ø¬Ù„ Ø§Ù„Ø­Ø¯Ø« ÙÙŠ Firebase.</p>

    <div class="row">
      <input id="phoneInput" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù‡Ù†Ø§..." />
      <div class="badge">ØªÙ„Ù‚Ø§Ø¦ÙŠ</div>
    </div>

    <div class="info">
      <div class="small-muted">Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ:</div>
      <ul id="ownerList" style="margin:8px 0 0 0;padding-left:18px"></ul>
    </div>

    <div class="info">
      <label class="small-muted">Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„):</label>
      <div style="margin-top:8px">
        <input id="messageInput" type="text" value="ğŸ”” Ø§Ù„Ø³Ø§Ø¯Ø© Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ â€” Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„ØªØ¬Ø±Ø¨Ø© ÙÙ‚Ø·" />
      </div>
    </div>

    <div class="log" id="logBox">
      <div><strong>Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«:</strong></div>
    </div>

    <p class="small-muted" style="margin-top:12px">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙŠØ³ØªØ®Ø¯Ù… Firebase Firestore Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª.</p>
  </div>

  <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ -->
  <div id="overlay" class="overlay" role="dialog" aria-hidden="true">
    <div class="alert-box">
      <img id="alertIcon" src="https://i.ibb.co/chmmTz2p/alert-icon.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡"/>
      <div class="alert-content">
        <div class="alert-title">ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø§Ø¬Ù„ â€” Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</div>
        <div class="alert-text" id="alertMessage">â€”</div>
        <div class="alert-actions">
          <button id="stopBtn" class="btn btn-stop">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª</button>
          <button id="dismissBtn" class="btn btn-dismiss">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>

<script>
/* Ø¥Ø¹Ø¯Ø§Ø¯ Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAyowWAzM5tpmNVxx_1XoxZpQIRSKkRExA",
  authDomain: "al-zahrani-platform.firebaseapp.com",
  projectId: "al-zahrani-platform",
  storageBucket: "al-zahrani-platform.firebasestorage.app",
  messagingSenderId: "69640690245",
  appId: "1:69640690245:web:580a8113c9a751771aa12c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ */
const ownerNumbers = [
  "+966555956147",
  "+966570460094",
  "+966582976776"
];
const ownerList = document.getElementById('ownerList');
ownerNumbers.forEach(n=>{
  const li=document.createElement('li');
  li.textContent=n;
  ownerList.appendChild(li);
});

/* Ø¹Ù†Ø§ØµØ± DOM */
const phoneInput=document.getElementById('phoneInput');
const logBox=document.getElementById('logBox');
const overlay=document.getElementById('overlay');
const alertMessage=document.getElementById('alertMessage');
const stopBtn=document.getElementById('stopBtn');
const dismissBtn=document.getElementById('dismissBtn');
const messageInput=document.getElementById('messageInput');
const alertIcon=document.getElementById('alertIcon');

/* Ø¯Ø§Ù„Ø© ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ø±Ù‚Ù… */
function normalizeNumber(input){
  if(!input) return "";
  let v=input.replace(/\s+/g,'').replace(/-/g,'');
  if(/^0\d{8,9}$/.test(v)) v='+966'+v.slice(1);
  if(/^[5]\d{8,9}$/.test(v)) v='+966'+v;
  if(/^966\d+/.test(v)&&v[0]!=='+' ) v='+'+v;
  return v;
}

/* ØµÙˆØª ØµÙØ§Ø±Ø© Ø¥Ù†Ø°Ø§Ø± */
function createSiren(){
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const osc=ctx.createOscillator();
  const gain=ctx.createGain();
  osc.type='sine'; osc.frequency.value=700;
  gain.gain.value=0.0001;
  osc.connect(gain); gain.connect(ctx.destination);
  osc.start();
  let up=true, running=true;
  const interval=setInterval(()=>{
    if(!running) return;
    const target=up?1200:650;
    osc.frequency.linearRampToValueAtTime(target,ctx.currentTime+0.25);
    up=!up;
  },450);
  gain.gain.linearRampToValueAtTime(1.0,ctx.currentTime+0.08);
  function stop(){
    running=false; clearInterval(interval);
    gain.gain.linearRampToValueAtTime(0.0001,ctx.currentTime+0.25);
    setTimeout(()=>{try{osc.stop();ctx.close();}catch(e){}},350);
  }
  return {stop};
}

let sirenController=null;

/* Firestore ØªØ³Ø¬ÙŠÙ„ */
async function registerSubscriber(phone){
  try{
    await db.collection('subscribers').doc(phone).set({
      phone, registeredAt: firebase.firestore.FieldValue.serverTimestamp()
    },{merge:true});
    appendLog(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±Ùƒ: ${phone}`);
  }catch(e){appendLog('Ø®Ø·Ø£: '+e.message);}
}

async function logAlert(phone,message){
  try{
    await db.collection('alerts').add({
      phone,message,ts:firebase.firestore.FieldValue.serverTimestamp()
    });
    appendLog(`Ø³Ø¬Ù„ ØªÙ†Ø¨ÙŠÙ‡: ${phone}`);
  }catch(e){appendLog('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„: '+e.message);}
}

/* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
function appendLog(text){
  const p=document.createElement('div');
  p.textContent=`[${new Date().toLocaleTimeString()}] ${text}`;
  logBox.appendChild(p);
  logBox.scrollTop=logBox.scrollHeight;
}

let lastCheck=null,lastMatched=null;
function checkInputDebounced(){
  if(lastCheck) clearTimeout(lastCheck);
  lastCheck=setTimeout(async()=>{
    const raw=phoneInput.value.trim();
    const norm=normalizeNumber(raw);
    if(!norm) return;
    appendLog('ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù…: '+norm);
    await registerSubscriber(norm);
    const found=ownerNumbers.includes(norm);
    if(found&&lastMatched!==norm){
      lastMatched=norm;
      const message=messageInput.value||'ØªÙ†Ø¨ÙŠÙ‡ ØªØ¬Ø±ÙŠØ¨ÙŠ';
      showAlert(message);
      await logAlert(norm,message);
    }
  },450);
}
phoneInput.addEventListener('input',checkInputDebounced);

/* Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ */
function showAlert(message){
  alertMessage.textContent=message;
  overlay.style.display='flex';
  if(sirenController) try{sirenController.stop();}catch(e){}
  try{
    sirenController=createSiren();
    appendLog('ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ù†Ø°Ø§Ø±');
  }catch(e){
    appendLog('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª: '+e.message);
  }
}
function stopSiren(){
  if(sirenController){try{sirenController.stop();}catch(e){}sirenController=null;appendLog('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª');}
}
stopBtn.addEventListener('click',()=>{stopSiren();});
dismissBtn.addEventListener('click',()=>{stopSiren();overlay.style.display='none';});
appendLog('Ø§Ù„ØµÙØ­Ø© Ø¬Ø§Ù‡Ø²Ø© â€” Ø§ÙƒØªØ¨ Ø±Ù‚Ù…Ùƒ Ù„Ù„Ø¨Ø¯Ø¡.');
</script>
</body>
</html>

