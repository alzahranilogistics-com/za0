<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… Ø¥Ù†Ø°Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ</title>
<style>
  :root{--accent:#d32f2f}
  body{font-family: "Segoe UI", Tahoma, Arial; background:#f4f6f8; margin:0; padding:20px}
  .card{max-width:900px;margin:20px auto;background:#fff;border-radius:12px;padding:22px;box-shadow:0 8px 30px rgba(15,15,15,0.06)}
  h1{margin:0 0 6px 0;font-size:20px}
  p.small{color:#666;margin-top:0}
  .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  input[type=text]{flex:1;padding:12px;border-radius:8px;border:1px solid #ccc;font-size:16px}
  .badge{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;font-weight:700}
  .info{margin-top:14px;color:#333}
  .log{margin-top:14px;background:#fafafa;padding:10px;border-radius:8px;border:1px dashed #eee;max-height:160px;overflow:auto}
  .small-muted{font-size:13px;color:#777}
  /* Modal Alert */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;z-index:9999}
  .alert-box{background:#fff;color:#111;padding:24px;border-radius:12px;max-width:820px;width:95%;display:flex;gap:18px;align-items:center;box-shadow:0 20px 60px rgba(0,0,0,0.35)}
  .alert-box img{width:96px;height:96px;border-radius:12px;object-fit:cover}
  .alert-content{flex:1}
  .alert-title{font-size:20px;margin:0 0 6px 0;color:var(--accent)}
  .alert-text{font-size:18px;margin:0 0 12px 0}
  .alert-actions{display:flex;gap:10px}
  .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .btn-stop{background:#444;color:#fff}
  .btn-dismiss{background:#eee;color:#111}
</style>
</head>
<body>
  <div class="card">
    <h1>Ù†Ø¸Ø§Ù… Ø¥Ù†Ø°Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ â€” Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</h1>
    <p class="small">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ (Ù…Ø«Ø§Ù„: 0551234567 Ø£Ùˆ +966551234567). Ø¹Ù†Ø¯ ÙƒØªØ§Ø¨Ø© Ø£ÙŠ Ù…Ù† Ø£Ø±Ù‚Ø§Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø³ÙŠØ´ØºÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ØªÙ†Ø¨ÙŠÙ‡Ù‹Ø§ ØªØ¬Ø±ÙŠØ¨ÙŠÙ‹Ø§ ÙˆÙŠØ³Ø¬Ù„ Ø§Ù„Ø­Ø¯Ø« ÙÙŠ Firebase.</p>

    <div class="row">
      <input id="phoneInput" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù‡Ù†Ø§..." />
      <div class="badge">ØªÙ„Ù‚Ø§Ø¦ÙŠ</div>
    </div>

    <div class="info">
      <div class="small-muted">Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ (Ù…Ù‚Ø§Ø±Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©):</div>
      <ul id="ownerList" style="margin:8px 0 0 0;padding-left:18px"></ul>
    </div>

    <div class="info">
      <label class="small-muted">Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡):</label>
      <div style="margin-top:8px">
        <input id="messageInput" type="text" value="ğŸ”” Ø§Ù„Ø³Ø§Ø¯Ø© Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ â€” Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„ØªØ¬Ø±Ø¨Ø© ÙÙ‚Ø·" />
      </div>
    </div>

    <div class="log" id="logBox">
      <div><strong>Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«:</strong></div>
    </div>

    <p class="small-muted" style="margin-top:12px">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙŠØ³ØªØ®Ø¯Ù… Firebase Firestore Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª. Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø®Ø§Ø¯Ù….</p>
  </div>

  <!-- Alert overlay -->
  <div id="overlay" class="overlay" role="dialog" aria-hidden="true">
    <div class="alert-box">
      <img id="alertIcon" src="https://i.ibb.co/9sWjQW2/alert-icon.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡"/>
      <div class="alert-content">
        <div class="alert-title">ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø§Ø¬Ù„ â€” Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</div>
        <div class="alert-text" id="alertMessage">â€”</div>
        <div class="alert-actions">
          <button id="stopBtn" class="btn btn-stop">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª</button>
          <button id="dismissBtn" class="btn btn-dismiss">Ø§ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>

<script>
/* ========== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase (Ø§Ø³ØªØ®Ø¯Ù…Øª Ù…Ø§ Ø£Ø¹Ø·ÙŠØªÙÙ‡) ========== */
const firebaseConfig = {
  apiKey: "AIzaSyAyowWAzM5tpmNVxx_1XoxZpQIRSKkRExA",
  authDomain: "al-zahrani-platform.firebaseapp.com",
  projectId: "al-zahrani-platform",
  storageBucket: "al-zahrani-platform.firebasestorage.app",
  messagingSenderId: "69640690245",
  appId: "1:69640690245:web:580a8113c9a751771aa12c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ========== Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„ØªÙŠ Ø£Ø¹Ø·ÙŠØªÙ‡Ø§ (Ù†Ù…Ø°Ø¬ØªÙ‡Ø§) ========== */
const ownerNumbers = [
  "+966555956147",
  "+966570460094",
  "+966582976776"
];
// Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹)
const ownerList = document.getElementById('ownerList');
ownerNumbers.forEach(n=> {
  const li = document.createElement('li');
  li.textContent = n;
  ownerList.appendChild(li);
});

/* ========== Ø¹Ù†Ø§ØµØ± DOM ========== */
const phoneInput = document.getElementById('phoneInput');
const logBox = document.getElementById('logBox');
const overlay = document.getElementById('overlay');
const alertMessage = document.getElementById('alertMessage');
const stopBtn = document.getElementById('stopBtn');
const dismissBtn = document.getElementById('dismissBtn');
const messageInput = document.getElementById('messageInput');
const alertIcon = document.getElementById('alertIcon');

/* Ø§Ø³ØªØ®Ø¯Ù…Øª Ø´Ø¹Ø§Ø±Ùƒ (Ø±Ø§Ø¨Ø· iBB Ø§Ù„Ø°ÙŠ Ø£Ø¹Ø·ÙŠØªÙÙ‡). Ø¥Ø°Ø§ ØªØ±ØºØ¨ Ø¨ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø¹Ø§Ø± Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§: */
alertIcon.src = "https://i.ibb.co/chmmTz2p/alert-icon.png";

/* ========== Helpers: ØªØ·Ø¨ÙŠØ¹ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆØ§ØªÙ ========== */
function normalizeNumber(input){
  if(!input) return "";
  let v = input.replace(/\s+/g,'').replace(/-/g,'');
  // Ù„Ùˆ Ø¨Ø¯Ø£ Ø¨Ù€0 Ù…Ø«Ù„ 055... Ù†Ø¹Ù…Ù„ +9665...
  if(/^0\d{8,9}$/.test(v)){
    v = '+966' + v.slice(1);
  }
  // Ù„Ùˆ Ø¨Ø¯Ø£ Ø¨Ù€5... (Ø¨Ø¯ÙˆÙ† 0): +9665...
  if(/^[5]\d{8,9}$/.test(v)){
    v = '+966' + v;
  }
  // Ù„Ùˆ Ø¨Ø¯Ø£ Ø¨Ù€966 Ø¯ÙˆÙ† +:
  if(/^966\d+/.test(v) && v[0] !== '+') v = '+' + v;
  return v;
}

/* ========== WebAudio: Ù…ÙˆÙ„Ø¯ ØµÙˆØª ØµÙØ§Ø±Ø© Ø·ÙˆØ§Ø±Ø¦ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ ==========
   Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªÙ†Ø´Ø¦ ØµÙˆØª ØµÙØ§Ø±Ø© Ù…ØªØ°Ø¨Ø°Ø¨ (siren-like). Ù…ØªØ­ÙƒÙ… stop Ø¹Ø¨Ø± returned stop().
*/
function createSiren() {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  osc.type = 'sine';
  osc.frequency.value = 700; // base

  gain.gain.value = 0;
  gain.gain.linearRampToValueAtTime(0.0001, ctx.currentTime);

  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.start();

  // LFO: Ù†ØºÙŠØ± Ø§Ù„ØªØ±Ø¯Ø¯ Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ Ø¨ÙŠÙ† 600 Ùˆ 1200
  let up = true;
  let running = true;
  const interval = setInterval(()=>{
    if(!running) return;
    const target = up ? 1200 : 650;
    // smooth ramp
    osc.frequency.cancelScheduledValues(ctx.currentTime);
    osc.frequency.linearRampToValueAtTime(target, ctx.currentTime + 0.25);
    up = !up;
  }, 450);

  // fade in
  gain.gain.cancelScheduledValues(ctx.currentTime);
  gain.gain.linearRampToValueAtTime(1.0, ctx.currentTime + 0.08);

  function stop(){
    running = false;
    clearInterval(interval);
    // fade out then stop
    gain.gain.cancelScheduledValues(ctx.currentTime);
    gain.gain.linearRampToValueAtTime(0.0001, ctx.currentTime + 0.25);
    setTimeout(()=> {
      try{ osc.stop(); ctx.close(); }catch(e){}
    }, 350);
  }
  return { stop };
}

/* Ø­Ø§Ù„Ø© Ø­Ø§Ù„ÙŠØ© */
let sirenController = null;

/* ========== ØªØ³Ø¬ÙŠÙ„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Firestore ==========
   Ù†Ø®Ø²Ù† Ø¶Ù…Ù† collections:
   - subscribers (doc id = phone) ÙŠØ­ØªÙˆÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©
   - alerts Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª: phone, message, timestamp
*/
async function registerSubscriber(phone){
  try{
    await db.collection('subscribers').doc(phone).set({
      phone,
      registeredAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
    appendLog(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±Ùƒ: ${phone}`);
  }catch(err){
    appendLog('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±Ùƒ: ' + err.message);
  }
}

async function logAlert(phone, message){
  try{
    await db.collection('alerts').add({
      phone, message,
      ts: firebase.firestore.FieldValue.serverTimestamp()
    });
    appendLog(`Ø³Ø¬Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ${phone}`);
  }catch(err){
    appendLog('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡: ' + err.message);
  }
}

/* ========== ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ³Ù„ÙˆÙƒ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ==========
   Ù†Ø±ÙŠØ¯: Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙˆØ±ÙŠÙ‹Ø§ØŒ ÙˆØ¥Ø°Ø§ ØªØ·Ø§Ø¨Ù‚Øª Ù…Ø¹ Ù…Ø§Ù„Ùƒ â†’ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±.
*/
function appendLog(text){
  const p = document.createElement('div');
  p.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
  logBox.appendChild(p);
  logBox.scrollTop = logBox.scrollHeight;
}

/* Debounce Ù„Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¹Ù†Ø¯ ÙƒÙ„ Ø­Ø±Ù */
let lastCheck = null;
let lastMatched = null;
function checkInputDebounced(){
  if(lastCheck) clearTimeout(lastCheck);
  lastCheck = setTimeout(async ()=>{
    const raw = phoneInput.value.trim();
    const norm = normalizeNumber(raw);
    if(!norm) return;
    appendLog('ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù…: ' + norm);
    // Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù†Ø®Ø²Ù† Ø§Ù„Ù…Ø´ØªØ±Ùƒ (Ø­Ø°Ù Ø¥Ø°Ø§ ÙØ§Ø±Øº) â€” Ù„Ø£Ù†Ùƒ Ø£Ø±Ø¯Øª ØªØ³Ø¬ÙŠÙ„ Ø£Ø±Ù‚Ø§Ù…Ùƒ
    await registerSubscriber(norm);

    // Ù‡Ù„ Ù‡Ùˆ Ø¶Ù…Ù† Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙƒØŸ
    const found = ownerNumbers.includes(norm);
    if(found && lastMatched !== norm){
      lastMatched = norm;
      // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
      const message = messageInput.value || 'ØªÙ†Ø¨ÙŠÙ‡ ØªØ¬Ø±ÙŠØ¨ÙŠ';
      showAlert(message);
      await logAlert(norm, message);
    }
  }, 450);
}

/* Ø§Ù„Ø­Ø¯Ø« Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ù†Ø© */
phoneInput.addEventListener('input', checkInputDebounced);

/* ========== Ø¹Ø±Ø¶/Ø¥ÙŠÙ‚Ø§Ù ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ========= */
function showAlert(message){
  alertMessage.textContent = message;
  overlay.style.display = 'flex';
  // Ø´ØºÙ„ Ø§Ù„ØµÙˆØª (Ø³ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙØ§Ø¹Ù„ Ø¨ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ù‚Ù…)
  if(sirenController) try{ sirenController.stop(); }catch(e){}
  try{
    sirenController = createSiren();
    appendLog('ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ù†Ø°Ø§Ø±');
  }catch(e){
    appendLog('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ³Ù…Ø­ Ø¨ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹: ' + e.message);
  }
}
function stopSiren(){
  if(sirenController){ try{ sirenController.stop(); }catch(e){} sirenController = null; appendLog('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª'); }
}
stopBtn.addEventListener('click', ()=>{ stopSiren(); });
dismissBtn.addEventListener('click', ()=>{ stopSiren(); overlay.style.display = 'none'; });

/* Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©: Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ© */
appendLog('Ø§Ù„ØµÙØ­Ø© Ø¬Ø§Ù‡Ø²Ø©. Ø§ÙƒØªØ¨ Ø±Ù‚Ù…Ùƒ Ù„Ù„Ø¨Ø¯Ø¡.');

/* Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ù„Ùˆ Ø£Ø±Ø¯Øª ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¸Ù‡Ø§Ø±Ù‡Ø§ Ù‡Ù†Ø§ (ØªØ¹Ù„ÙŠÙ‚) */
/*
db.collection('alerts').orderBy('ts','desc').limit(10).get().then(snapshot=>{
  snapshot.forEach(doc=>{
    const d = doc.data();
    appendLog(`Ø³Ø¬Ù„ Ø³Ø§Ø¨Ù‚ - ${d.phone}: ${d.message} @ ${d.ts?.toDate?.() || ''}`);
  });
});
*/
</script>
</body>
</html>
